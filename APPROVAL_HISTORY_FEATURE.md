# 审批历史记录功能实现文档

## 功能概述

在项目启动审批页面添加了历史记录功能，可以查看所有已处理的审批请求，并且所有操作都记录到MongoDB日志中。

## 实现内容

### 1. 后端API实现

#### 文件：`back/app/api/routes/projects.py`

**新增API端点：**

**获取历史审批记录** - `GET /api/projects/startup-requests/history`
- 权限：仅管理员
- 查询参数：
  - `status`: 筛选状态（approved/rejected/all），默认显示已审批和已拒绝
  - `limit`: 返回数量，默认50条
- 返回数据包含：
  - 项目信息
  - 申请人和审批人信息
  - 申请理由和拒绝理由
  - 审批时间、启动时间、过期时间
  - 进程ID和运行状态

**响应示例：**
```json
[
  {
    "id": "uuid",
    "project_id": "uuid",
    "project_name": "项目名称",
    "requester_id": "uuid",
    "requester_name": "申请人",
    "approver_id": "uuid",
    "approver_name": "审批人",
    "request_reason": "申请理由",
    "reject_reason": "拒绝理由（如果被拒绝）",
    "status": "approved/rejected",
    "approved_at": "2024-01-01T00:00:00Z",
    "started_at": "2024-01-01T00:00:00Z",
    "expires_at": "2024-01-01T01:00:00Z",
    "is_running": true,
    "process_id": 12345,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
]
```

### 2. 前端审批页面改进

#### 文件：`front/app/(dashboard)/admin/approvals/page.tsx`

**新增功能：**

1. **标签页导航**
   - 待审批标签页：显示所有待处理的请求
   - 历史记录标签页：显示已处理的请求

2. **历史记录筛选**
   - 全部：显示所有已处理的记录
   - 已通过：只显示审批通过的记录
   - 已拒绝：只显示审批拒绝的记录

3. **统计卡片**
   - 待审批数量
   - 历史记录数量

4. **历史记录卡片显示**
   - 左侧边框颜色：绿色（已通过）/ 红色（已拒绝）
   - 状态徽章：带图标的彩色徽章
   - 详细信息：
     - 申请人和审批人
     - 申请时间和审批时间
     - 申请理由
     - 拒绝理由（如果被拒绝）
     - 启动信息（如果已通过）：
       - 启动时间
       - 过期时间
       - 进程ID
       - 运行状态

### 3. MongoDB日志记录

#### 文件：`back/app/services/audit_log.py`

**日志服务已存在并完善：**

所有审批操作都会自动记录到MongoDB的`audit_logs`集合中：

1. **用户提交申请**
   - action: `request_startup`
   - resource_type: `project`
   - 记录申请理由

2. **管理员直接启动**
   - action: `start`
   - resource_type: `project`
   - 记录启动时长和时间

3. **审批通过**
   - action: `approve_startup`
   - resource_type: `project_startup_request`
   - 记录项目信息和启动参数

4. **审批拒绝**
   - action: `reject_startup`
   - resource_type: `project_startup_request`
   - 记录拒绝理由

**日志字段：**
```json
{
  "user_id": "用户ID",
  "action": "操作类型",
  "resource_type": "资源类型",
  "resource_id": "资源ID",
  "changes": {
    "详细变更信息": "..."
  },
  "ip_address": "IP地址",
  "user_agent": "用户代理",
  "status": "success/failed",
  "error_message": "错误信息（如果失败）",
  "timestamp": "时间戳"
}
```

## 使用说明

### 查看历史记录

1. 登录管理员账号
2. 点击右上角头像 → 选择"审批管理"
3. 点击"历史记录"标签页
4. 使用筛选器选择要查看的记录类型：
   - 全部：查看所有已处理的记录
   - 已通过：只查看审批通过的记录
   - 已拒绝：只查看审批拒绝的记录

### 历史记录信息

**已通过的记录显示：**
- 绿色左边框
- 绿色"已通过"徽章
- 申请人和审批人信息
- 申请时间和审批时间
- 申请理由
- 启动时间和过期时间
- 进程ID（如果有）
- 当前运行状态

**已拒绝的记录显示：**
- 红色左边框
- 红色"已拒绝"徽章
- 申请人和审批人信息
- 申请时间和审批时间
- 申请理由
- 拒绝理由（红色背景高亮显示）

### 查看MongoDB日志

可以通过以下方式查看详细的操作日志：

1. **通过API查询**（需要超级管理员权限）：
   ```
   GET /api/admin/logs?action=approve_startup
   GET /api/admin/logs?resource_type=project_startup_request
   ```

2. **直接查询MongoDB**：
   ```javascript
   db.audit_logs.find({
     action: { $in: ["approve_startup", "reject_startup", "request_startup"] }
   }).sort({ timestamp: -1 })
   ```

3. **按用户查询**：
   ```javascript
   db.audit_logs.find({
     user_id: "用户ID",
     resource_type: "project_startup_request"
   }).sort({ timestamp: -1 })
   ```

## 界面展示

### 统计卡片
```
┌─────────────┐  ┌─────────────┐
│ 待审批      │  │ 历史记录    │
│ 🕐          │  │ 📜          │
│ 3           │  │ 15          │
│ 需要处理... │  │ 已处理...   │
└─────────────┘  └─────────────┘
```

### 标签页
```
┌─ 待审批 ─┬─ 历史记录 ─┐
│                        │
│  [待审批列表]          │
│                        │
└────────────────────────┘
```

### 历史记录卡片（已通过）
```
┃ 项目名称                    ✓ 已通过
┃ 
┃ 申请人：张三        审批人：管理员
┃ 申请时间：...       审批时间：...
┃ 
┃ ┌─ 申请理由 ──────────────┐
┃ │ 需要测试新功能...        │
┃ └──────────────────────────┘
┃ 
┃ 启动时间：...       过期时间：...
┃ 进程ID：12345       运行状态：运行中
```

### 历史记录卡片（已拒绝）
```
┃ 项目名称                    ✗ 已拒绝
┃ 
┃ 申请人：李四        审批人：管理员
┃ 申请时间：...       审批时间：...
┃ 
┃ ┌─ 申请理由 ──────────────┐
┃ │ 需要紧急修复bug...       │
┃ └──────────────────────────┘
┃ 
┃ ┌─ 拒绝理由 ──────────────┐
┃ │ 当前服务器资源不足...    │
┃ └──────────────────────────┘
```

## 技术特点

1. **实时更新**：切换到历史记录标签页时自动加载数据
2. **筛选功能**：支持按状态筛选，切换筛选器时自动刷新
3. **详细信息**：显示完整的审批流程信息
4. **视觉区分**：通过颜色和图标清晰区分不同状态
5. **响应式设计**：适配不同屏幕尺寸
6. **加载状态**：显示加载动画，提升用户体验
7. **空状态处理**：无数据时显示友好提示

## 数据流程

```
用户提交申请
    ↓
记录到数据库 (project_startup_requests)
    ↓
记录到MongoDB日志 (action: request_startup)
    ↓
管理员审批
    ↓
更新数据库状态
    ↓
记录到MongoDB日志 (action: approve_startup/reject_startup)
    ↓
历史记录页面显示
```

## 权限控制

- **查看历史记录**：仅管理员和超级管理员
- **筛选功能**：所有管理员可用
- **日志查询**：超级管理员可通过API查询详细日志

## 性能优化

1. **按需加载**：只在切换到历史记录标签页时加载数据
2. **分页支持**：默认返回50条记录，可配置
3. **索引优化**：数据库查询使用索引（status, updated_at）
4. **缓存策略**：筛选器切换时重新请求数据

## 后续优化建议

1. **分页功能**：
   - 添加分页控件
   - 支持加载更多

2. **搜索功能**：
   - 按项目名称搜索
   - 按申请人搜索

3. **导出功能**：
   - 导出历史记录为Excel
   - 导出日志为CSV

4. **统计图表**：
   - 审批通过率
   - 审批时长统计
   - 按时间段统计

5. **通知集成**：
   - 审批结果推送通知
   - 邮件通知

6. **详情对话框**：
   - 点击记录查看完整详情
   - 显示关联的日志记录

## 文件清单

### 后端文件
- `back/app/api/routes/projects.py` - 添加历史记录API
- `back/app/services/audit_log.py` - MongoDB日志服务（已存在）

### 前端文件
- `front/app/(dashboard)/admin/approvals/page.tsx` - 审批页面（修改）

## 测试建议

1. **功能测试**：
   - 提交多个审批请求
   - 审批通过和拒绝
   - 切换到历史记录标签页
   - 使用筛选器切换状态

2. **数据验证**：
   - 检查历史记录显示是否正确
   - 验证审批人信息是否正确
   - 确认时间格式正确

3. **日志验证**：
   - 查询MongoDB确认日志已记录
   - 验证日志字段完整性
   - 检查错误日志记录

4. **性能测试**：
   - 测试大量历史记录的加载速度
   - 验证筛选器响应速度

## 注意事项

1. MongoDB必须启用才能记录日志
2. 历史记录默认显示最近50条
3. 审批人信息通过关联查询获取
4. 时间显示使用本地时区格式化
5. 运行状态仅供参考，实际状态需要检查进程
