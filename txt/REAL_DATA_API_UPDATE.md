# çœŸå®æ•°æ®APIæ›´æ–°æ€»ç»“

## âœ… å·²å®Œæˆçš„æ›´æ–°

### ğŸ¯ æ ¸å¿ƒæ”¹å˜ï¼šä»ç¡¬ç¼–ç æ•°æ®æ”¹ä¸ºçœŸå®æ•°æ®åº“æŸ¥è¯¢

ä¹‹å‰çš„é—®é¢˜ï¼šåç«¯APIè¿”å›ç¡¬ç¼–ç çš„å‡æ•°æ®
ç°åœ¨çš„è§£å†³æ–¹æ¡ˆï¼šä»æ•°æ®åº“æŸ¥è¯¢çœŸå®çš„æœˆåº¦ç»Ÿè®¡æ•°æ®

### ğŸ“Š åç«¯APIæ›´æ–° (`back/app/api/routes/dashboard.py`)

#### 1. æ·»åŠ æ–°çš„ä¾èµ–å¯¼å…¥
```python
from datetime import datetime, timedelta
from dateutil.relativedelta import relativedelta
from sqlalchemy import func, extract, select
from app.models.tables import (
    Paper, Patent, Project, Resource, SoftwareCopyright, 
    Competition, Conference, Cooperation
)
```

#### 2. æ–°å¢ `get_monthly_trends()` å‡½æ•°
è¿™ä¸ªå‡½æ•°æ‰§è¡ŒçœŸå®çš„æ•°æ®åº“æŸ¥è¯¢ï¼š

**åŠŸèƒ½ï¼š**
- è·å–æœ€è¿‘6ä¸ªæœˆçš„æ•°æ®
- æŒ‰æœˆä»½ç»Ÿè®¡å„æ¨¡å—çš„åˆ›å»ºæ•°é‡
- ä½¿ç”¨SQLçš„ `extract()` å‡½æ•°æŒ‰å¹´æœˆåˆ†ç»„
- è¿”å›çœŸå®çš„ç»Ÿè®¡æ•°æ®

**æŸ¥è¯¢é€»è¾‘ï¼š**
```python
# å¯¹æ¯ä¸ªæ¨¡å—æ‰§è¡Œç±»ä¼¼æŸ¥è¯¢
papers_count = await db.execute(
    select(func.count(Paper.id)).where(
        extract('year', Paper.created_at) == year,
        extract('month', Paper.created_at) == month
    )
)
```

**æ¶µç›–çš„æ¨¡å—ï¼š**
- âœ… è®ºæ–‡ (Paper)
- âœ… ä¸“åˆ© (Patent)  
- âœ… é¡¹ç›® (Project)
- âœ… è½¯è‘— (SoftwareCopyright)
- âœ… ç«èµ› (Competition)
- âœ… ä¼šè®® (Conference)
- âœ… åˆä½œ (Cooperation)

#### 3. æ›´æ–°ä¸»APIè°ƒç”¨æ–¹å¼
```python
# ä¹‹å‰ï¼šç¡¬ç¼–ç æ•°æ®
"trend_data": [
    {"month": "2024-01", "papers": 12, ...},  # å‡æ•°æ®
    ...
]

# ç°åœ¨ï¼šçœŸå®æ•°æ®åº“æŸ¥è¯¢
"trend_data": await get_monthly_trends(db),
```

### ğŸ“ˆ æ•°æ®è¿”å›æ ¼å¼

**APIå“åº”ç»“æ„ï¼š**
```json
{
  "research_overview": [...],
  "trend_data": [
    {
      "month": "2024-06",
      "papers": 2,        // çœŸå®æ•°æ®
      "patents": 2,       // çœŸå®æ•°æ®
      "projects": 2,      // çœŸå®æ•°æ®
      "software": 2,      // çœŸå®æ•°æ®
      "competitions": 2,  // çœŸå®æ•°æ®
      "conferences": 3,   // çœŸå®æ•°æ®
      "cooperations": 3   // çœŸå®æ•°æ®
    },
    {
      "month": "2024-07",
      "papers": 0,        // å¦‚æœè¯¥æœˆæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º0
      "patents": 0,
      // ...
    },
    // ... å…±6ä¸ªæœˆæ•°æ®
  ],
  "achievement_stats": {...}
}
```

### ğŸ” æ•°æ®æŸ¥è¯¢ç­–ç•¥

#### æœˆä»½è®¡ç®—é€»è¾‘
- ä»å½“å‰æœˆä»½å¼€å§‹ï¼Œå‘å‰æ¨6ä¸ªæœˆ
- ä½¿ç”¨ `relativedelta` å‡†ç¡®è®¡ç®—æœˆä»½å·®å¼‚
- æ ¼å¼åŒ–ä¸º "YYYY-MM" å­—ç¬¦ä¸²

#### SQLæŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ `extract('year', created_at)` å’Œ `extract('month', created_at)` è¿›è¡Œé«˜æ•ˆçš„æœˆä»½è¿‡æ»¤
- æ¯ä¸ªæ¨¡å—ç‹¬ç«‹æŸ¥è¯¢ï¼Œé¿å…å¤æ‚çš„JOIN
- ä½¿ç”¨ `func.count()` è¿›è¡Œè®¡æ•°ç»Ÿè®¡

#### æ•°æ®å¤„ç†
- å¦‚æœæŸæœˆæ²¡æœ‰æ•°æ®ï¼Œè¿”å›0è€Œä¸æ˜¯null
- æŒ‰æ—¶é—´æ­£åºæ’åˆ—ï¼ˆæœ€æ—©æœˆä»½åœ¨å‰ï¼‰
- ä¿è¯å‰ç«¯å›¾è¡¨èƒ½æ­£ç¡®æ¸²æŸ“

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. å®‰è£…æ–°ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
cd back
pip install python-dateutil==2.8.2
```

### 2. é‡å¯åç«¯æœåŠ¡
```bash
cd back
# åœæ­¢ç°æœ‰æœåŠ¡ (Ctrl+C)
python -m uvicorn app.main:app --reload
```

### 3. æµ‹è¯•APIç«¯ç‚¹
```bash
curl http://localhost:8000/api/dashboard/overview
```

**æ£€æŸ¥è¦ç‚¹ï¼š**
- `trend_data` æ•°ç»„åŒ…å«6ä¸ªæœˆæ•°æ®
- æ¯ä¸ªæœˆä»½çš„æ•°æ®éƒ½æ˜¯çœŸå®çš„æ•°å­—ï¼ˆåŸºäºæ•°æ®åº“ä¸­çš„ `created_at` å­—æ®µï¼‰
- å¦‚æœæŸæœˆæ²¡æœ‰åˆ›å»ºä»»ä½•æˆæœï¼Œè¯¥æœˆæ‰€æœ‰æ¨¡å—æ˜¾ç¤º0

### 4. å‰ç«¯éªŒè¯
è®¿é—® http://localhost:3000
- æŸ¥çœ‹é¦–é¡µçš„"æˆæœè¶‹åŠ¿"å›¾è¡¨
- éªŒè¯è¶‹åŠ¿çº¿æ˜¾ç¤ºçš„æ˜¯çœŸå®æ•°æ®
- å¦‚æœæ•°æ®åº“ä¸­åªæœ‰å½“å‰æœˆçš„æ•°æ®ï¼Œå…¶ä»–æœˆä»½åº”æ˜¾ç¤ºä¸º0

## ğŸ“Š é¢„æœŸç»“æœ

### åŸºäºæµ‹è¯•æ•°æ®çš„é¢„æœŸç»“æœ
æ ¹æ®ä¹‹å‰è¿è¡Œçš„ `generate_extended_test_data.py`ï¼š

**å½“å‰æœˆä»½ï¼ˆ2024å¹´11æœˆï¼‰åº”è¯¥æ˜¾ç¤ºï¼š**
- è®ºæ–‡: 2ç¯‡
- ä¸“åˆ©: 2ä¸ª
- é¡¹ç›®: 2ä¸ª
- è½¯è‘—: 2ä¸ª
- ç«èµ›: 2ä¸ª
- ä¼šè®®: 3ä¸ª
- åˆä½œ: 3ä¸ª

**å…¶ä»–æœˆä»½ï¼ˆå¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼‰ï¼š**
- æ‰€æœ‰æ¨¡å—éƒ½æ˜¾ç¤º0

### å›¾è¡¨æ˜¾ç¤ºæ•ˆæœ
- å½“å‰æœˆä»½ä¼šæœ‰æ˜æ˜¾çš„æ•°æ®å³°å€¼
- å†å²æœˆä»½å¦‚æœæ²¡æœ‰æ•°æ®ä¼šæ˜¾ç¤ºä¸º0ï¼Œå½¢æˆå¯¹æ¯”
- è¶‹åŠ¿çº¿ä¼šçœŸå®åæ˜ æ•°æ®åˆ›å»ºçš„æ—¶é—´åˆ†å¸ƒ

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šAPIè¿”å›ç©ºçš„trend_data
**å¯èƒ½åŸå› ï¼š**
- æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®
- `created_at` å­—æ®µä¸ºnull

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é‡æ–°ç”Ÿæˆæµ‹è¯•æ•°æ®
cd back
python generate_extended_test_data.py
```

### é—®é¢˜2ï¼šæ‰€æœ‰æœˆä»½éƒ½æ˜¾ç¤º0
**å¯èƒ½åŸå› ï¼š**
- æ•°æ®æ˜¯åˆšåˆ›å»ºçš„ï¼Œéƒ½åœ¨å½“å‰æœˆ
- æ—¶åŒºé—®é¢˜å¯¼è‡´æœˆä»½è®¡ç®—é”™è¯¯

**æ£€æŸ¥æ–¹æ³•ï¼š**
```sql
-- åœ¨æ•°æ®åº“ä¸­ç›´æ¥æŸ¥è¯¢
SELECT 
    extract('year', created_at) as year,
    extract('month', created_at) as month,
    count(*) as count
FROM papers 
GROUP BY extract('year', created_at), extract('month', created_at);
```

### é—®é¢˜3ï¼šImportError: dateutil
**è§£å†³æ–¹æ¡ˆï¼š**
```bash
pip install python-dateutil
```

## ğŸ’¡ æŠ€æœ¯ä¼˜åŠ¿

### ç›¸æ¯”ç¡¬ç¼–ç æ•°æ®çš„ä¼˜åŠ¿ï¼š
1. **çœŸå®æ€§** - æ˜¾ç¤ºå®é™…çš„ç§‘ç ”æˆæœåˆ›å»ºè¶‹åŠ¿
2. **åŠ¨æ€æ€§** - éšç€æ–°æ•°æ®çš„åŠ å…¥è‡ªåŠ¨æ›´æ–°
3. **å‡†ç¡®æ€§** - åŸºäºæ•°æ®åº“æ—¶é—´æˆ³çš„ç²¾ç¡®ç»Ÿè®¡
4. **å¯æ‰©å±•æ€§** - å®¹æ˜“æ·»åŠ æ–°çš„æ¨¡å—ç»Ÿè®¡

### æŸ¥è¯¢æ€§èƒ½ï¼š
- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–çš„æ—¶é—´æŸ¥è¯¢
- æŒ‰æœˆåˆ†ç»„å‡å°‘æ•°æ®é‡
- ç‹¬ç«‹æŸ¥è¯¢é¿å…å¤æ‚JOIN

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ ç¼“å­˜** - æœˆåº¦æ•°æ®å˜åŒ–ä¸é¢‘ç¹ï¼Œå¯ä»¥ç¼“å­˜ç»“æœ
2. **æ—¶é—´èŒƒå›´å¯é…ç½®** - å…è®¸ç”¨æˆ·é€‰æ‹©æŸ¥çœ‹çš„æœˆä»½èŒƒå›´
3. **æ•°æ®åº“ç´¢å¼•** - ä¸º `created_at` å­—æ®µæ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
4. **å¼‚æ­¥ä¼˜åŒ–** - ä½¿ç”¨ `asyncio.gather()` å¹¶å‘æ‰§è¡Œå¤šä¸ªæŸ¥è¯¢

ç°åœ¨è¶‹åŠ¿å›¾è¡¨æ˜¾ç¤ºçš„æ˜¯çœŸå®çš„æ•°æ®åº“ç»Ÿè®¡ï¼Œä¸å†æ˜¯å‡æ•°æ®ï¼ğŸ‰
